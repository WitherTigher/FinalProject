<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Forgot Password - Country Explorer</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>Forgot Password</h2>
		<!-- Step 1: Enter Email -->
		<div id="step1">
		<form id="emailForm">
			<label for="fpEmail">Enter your email:</label>
			<input type="email" id="fpEmail" required autocomplete="email">
			<button type="submit">Next</button>
		</form>
		<p id="fpMessage1"></p>
		</div>
		
		<!-- Step 2: Answer security question & enter new password -->
		<div id="step2" class="hidden">
		<p id="securityQuestion"></p>
		<form id="resetForm">
			<input type="hidden" id="userId">
			
			<label for="securityAnswer">Your Answer:</label>
			<input type="text" id="securityAnswer" required autocomplete="off">
			
			<label for="newPassword">New Password:</label>
			<input type="password" id="newPassword" required autocomplete="new-password">
			
			<label for="confirmNewPassword">Confirm New Password:</label>
			<input type="password" id="confirmNewPassword" required autocomplete="new-password">
			
			<button type="submit">Reset Password</button>
		</form>
		<p id="fpMessage2"></p>
		</div>

		<p><a href="login.html">Back to Login</a></p>
  </div>
	<script>
		const step1 = document.getElementById('step1');
		const step2 = document.getElementById('step2');
		const fpMessage1 = document.getElementById('fpMessage1');
		const fpMessage2 = document.getElementById('fpMessage2');
		const securityQuestion = document.getElementById('securityQuestion');
		const userId = document.getElementById('userId');
		
		// Step 1: Get security question
		document.getElementById('emailForm').addEventListener('submit', function(e) {
		e.preventDefault();
		const email = document.getElementById('fpEmail').value;
		
		fetch('get_security_question.php', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ email })
			})
			.then(response => response.json())
			.then(data => {
			if (data.success) {
				// Store user ID and show security question
				userId.value = data.userId;
				securityQuestion.textContent = data.question;
				step1.classList.add('hidden');
				step2.classList.remove('hidden');
			} else {
				fpMessage1.textContent = data.message;
			}
			})
			.catch(error => {
			console.error('Error:', error);
			fpMessage1.textContent = 'Error processing request.';
			});
		});
		
		// Step 2: Reset password
		document.getElementById('resetForm').addEventListener('submit', function(e) {
		e.preventDefault();
		
		const newPassword = document.getElementById('newPassword').value;
		const confirmPassword = document.getElementById('confirmNewPassword').value;
		
		if (newPassword !== confirmPassword) {
			fpMessage2.textContent = 'Passwords do not match.';
			return;
		}
		
		fetch('reset_password.php', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			userId: userId.value,
			answer: document.getElementById('securityAnswer').value,
			newPassword: newPassword
			})
			})
			.then(response => response.json())
			.then(data => {
			if (data.success) {
				fpMessage2.textContent = 'Password reset successful!';
				setTimeout(() => {
				window.location.href = 'login.html';
				}, 2000);
			} else {
				fpMessage2.textContent = data.message;
			}
			})
			.catch(error => {
			console.error('Error:', error);
			fpMessage2.textContent = 'Error processing request.';
			});
		});
	</script>
	<style>
		.hidden { display: none; }
	</style>
</body>
</html>
